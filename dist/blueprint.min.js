function binarySearch(t,i,e){return _binarySearch(t,i,e,0,t.length-1)}function _binarySearch(t,i,e,r,n){if(r>=n)return-1;var s=Math.floor((n+r)/2),p=e(t[s]);return p===i?s:p<i?_binarySearch(t,i,e,s+1,n):_binarySearch(t,i,e,r,s-1)}function getCanvasWidth(t){return t.canvas.clientWidth}function getCanvasHeight(t){return t.canvas.clientHeight}function strokeLine(t,i,e,r,n){t.beginPath(),t.moveTo(i,e),t.lineTo(r,n),t.stroke()}var EntityType;!function(t){t[t.Black=0]="Black",t[t.Blue=1]="Blue",t[t.Green=2]="Green",t[t.Red=3]="Red",t[t.Multi=4]="Multi"}(EntityType||(EntityType={}));var SpriteSheet=function(){function t(t){this.image=new Image,this.image.src=t}return t.prototype.getImage=function(){return this.image},t}(),SpriteType;!function(t){t[t.Black=0]="Black",t[t.Blue=1]="Blue",t[t.Green=2]="Green",t[t.Red=3]="Red"}(SpriteType||(SpriteType={}));var Sprite=function(){function t(t,i,e,r,n,s){this.spriteSheet=t,this.x=i,this.y=e,this.width=r,this.height=n,this.type=s}return t.prototype.draw=function(t,i,e,r,n){t.drawImage(this.spriteSheet.getImage(),this.x,this.y,this.width,this.height,i,e,r,n)},t}(),SpriteGroup=function(){function t(t){void 0===t&&(t=null),this.sprites=t||[],this.spriteIndex=-1}return t.prototype.addSprite=function(t){this.sprites.push(t)},t.prototype.next=function(){return 0===this.sprites.length?null:(this.spriteIndex=(this.spriteIndex+1)%this.sprites.length,this.sprites[this.spriteIndex])},t.prototype.previous=function(){return 0===this.sprites.length?null:(this.spriteIndex=(this.spriteIndex-1)%this.sprites.length,this.sprites[this.spriteIndex])},t}(),Entity=function(){function t(i,e,r){void 0===r&&(r=null),this.type=i,this.spriteGroup=r,this.type=i,this.sprite=e,this.id=t.currentId,++t.currentId}return t.prototype.moveTo=function(t,i){return this.x=t,this.y=i,this},t.prototype.draw=function(t,i,e,r,n){return null!==this.sprite?this.sprite.draw(t,i,e,r,n):null!==this.spriteGroup&&(this.nextSprite(),null!==this.sprite&&this.sprite.draw(t,i,e,r,n)),this},t.prototype.nextSprite=function(){return null!==this.spriteGroup&&(this.sprite=this.spriteGroup.next()),this},t.prototype.previousSprite=function(){return null!==this.spriteGroup&&(this.sprite=this.spriteGroup.previous()),this},t.currentId=1,t}(),Library=function(){function t(t,i){void 0===i&&(i=null),this.keyFn=i,this.storage=new Array(t)}return t.prototype.add=function(t,i){if(void 0===i&&(i=null),null===i){if(null===this.keyFn)throw Error("Must provide a key function");i=this.keyFn(t)}i>=this.storage.length&&this.resize(2*this.storage.length),this.storage[i]=t},t.prototype.get=function(t){var i=this.storage[t];return void 0===i?null:i},t.prototype.resize=function(t){this.storage.length=t},t}(),Factory=function(){function t(t){void 0===t&&(t=null),this.keyFn=t,this.library=new Library(100)}return t.prototype.add=function(t,i){this.library.add(i,this.getKey(t))},t.prototype.create=function(t){var i=this.library.get(this.getKey(t));return null===i?null:i()},t.prototype.getKey=function(t){return"number"==typeof t?t:this.keyFn(t)},t}(),Grid=function(){function t(t,i,e){void 0===e&&(e=32),this.width=t,this.height=i,this.gridSize=e,this.gridLines=!0}return t.prototype.getX=function(t){return t*this.gridSize},t.prototype.getY=function(t){return t*this.gridSize},t.prototype.setGridLines=function(t){return this.gridLines=t,this},t.prototype.toggleGridLines=function(){return this.gridLines=!this.gridLines,this},t.prototype.draw=function(i){if(this.gridLines){var e=i.strokeStyle,r=i.lineWidth;i.strokeStyle=t.gridLineStyle,i.lineWidth=t.gridLineWidth;for(var n=i.canvas.clientWidth,s=i.canvas.clientHeight,p=1;p<this.width;++p){var o=p*this.gridSize;strokeLine(i,o,0,o,s)}for(p=1;p<this.height;++p){var h=p*this.gridSize;strokeLine(i,0,h,n,h)}i.strokeStyle=e,i.lineWidth=r}return this},t.gridLineStyle="#777777",t.gridLineWidth=1,t}(),Scene=function(){function t(t,i,e){this.context=e,this.grid=new Grid(t,i),this.entities=[]}return t.prototype.clear=function(){this.context.clearRect(0,0,getCanvasWidth(this.context),getCanvasHeight(this.context))},t.prototype.draw=function(){this.clear(),this.grid.draw(this.context);for(var t=0,i=this.entities;t<i.length;t++){var e=i[t];e.draw(this.context,this.grid.getX(e.x),this.grid.getY(e.y),this.grid.gridSize,this.grid.gridSize)}},t.prototype.resize=function(t,i){this.grid=new Grid(t,i)},t.prototype.addEntity=function(t){this.entities.push(t),this.entities.sort(function(t,i){return t.id-i.id})},t.prototype.findEntity=function(t){return binarySearch(this.entities,t,function(t){return t.id})},t.prototype.getEntity=function(t){var i=this.findEntity(t);return i<0?null:this.entities[i]},t.prototype.removeEntity=function(t){var i=this.findEntity(t);return!(i<0)&&(this.entities.splice(i,1),!0)},t}(),spriteSheet=new SpriteSheet("spritesheet.png"),spriteLibrary=new Library(100,function(t){return t.type});spriteLibrary.add(new Sprite(spriteSheet,0,0,16,16,SpriteType.Black)),spriteLibrary.add(new Sprite(spriteSheet,16,0,16,16,SpriteType.Blue)),spriteLibrary.add(new Sprite(spriteSheet,0,16,16,16,SpriteType.Green)),spriteLibrary.add(new Sprite(spriteSheet,16,16,16,16,SpriteType.Red));var entityFactory=new Factory;entityFactory.add(EntityType.Black,function(){return new Entity(EntityType.Black,spriteLibrary.get(SpriteType.Black))}),entityFactory.add(EntityType.Blue,function(){return new Entity(EntityType.Blue,spriteLibrary.get(SpriteType.Blue))}),entityFactory.add(EntityType.Green,function(){return new Entity(EntityType.Green,spriteLibrary.get(SpriteType.Green))}),entityFactory.add(EntityType.Red,function(){return new Entity(EntityType.Red,spriteLibrary.get(SpriteType.Red))}),entityFactory.add(EntityType.Multi,function(){return new Entity(EntityType.Multi,null,new SpriteGroup([spriteLibrary.get(SpriteType.Blue),spriteLibrary.get(SpriteType.Red),spriteLibrary.get(SpriteType.Green)]))});